actions:
    orob2b_sale_expire_quote_action:
        label: orob2b.sale.quote.actions.quote_expire
        enabled: true
        applications: [backend]
        routes:
            - orob2b_sale_quote_view
        datagrids:
            - quotes-grid
        order: 10
        button_options:
            icon: icon-time
        frontend_options:
            confirmation: orob2b.sale.quote.actions.quote_expire_confirm
        preconditions:
            @equal: [$expired, false]
        functions:
            - @assign_value: [$expired, true]
            - @flash_message:
                message: orob2b.sale.quote.message.quote.expire.success
                type: 'info'
                message_parameters:
                    id: $id
            - @redirect:
                route: 'orob2b_sale_quote_index'

    orob2b_sale_notify_customer_by_email_action:
        label: orob2b.sale.quote.notify_customer.by_email.link.text
        applications: [backend, frontend]
        entities:
            - OroB2B\Bundle\SaleBundle\Entity\Quote
        order: 20
        acl_resource: oro_email_email_create

        button_options:
            icon: icon-envelope
            group: orob2b.sale.quote.notify_customer.label

        frontend_options:
            template: OroB2BSaleBundle:Action:emailNotification.html.twig
            title: orob2b.sale.quote.notify_customer.by_email.link.text
            options:
                allowMaximize: true
                allowMinimize: true
                dblclick: maximize
                maximizedHeightDecreaseBy: minimize-bar
                width: 1000

        attributes:
            email:
                label: ' '
                type: object
                options:
                    class: Oro\Bundle\EmailBundle\Form\Model\Email

        form_options:
            attribute_fields:
                email:
                    form_type: oro_email_email

        form_init:
            - @call_service_method:
                attribute: $.email
                service: orob2b_sale.helper.notification
                method: getEmailModel
                method_parameters: [$.data]
            - @call_service_method:
                attribute: $.appendSignature
                service: oro_config.user
                method: get
                method_parameters: ['oro_email.append_signature']

        functions:
            - @call_service_method:
                service: orob2b_sale.helper.notification
                method: send
                method_parameters: [$.email, $.data]

    orob2b_sale_send_no_quote_alert:
        label: orob2b.sale.quote.actions.send_no_quote_alert
        enabled: true
        applications: []
        order: 10
        functions:
            - @foreach:
                array: $accountUser.salesRepresentatives
                value: $.saleRep
                actions:
                    - @send_email_template:
                        conditions:
                            @not_empty: $accountUser.owner
                        parameters:
                            from: $accountUser.owner.email
                            to: $.saleRep.email
                            template: 'request_no_quote_alert'
                            entity: $.data
            - @call_method:
                object: $accountUser.salesRepresentatives
                method: toArray
                attribute: $.accountUserSalesReps
            - @foreach:
                array: $account.salesRepresentatives
                value: $.saleRep
                actions:
                    - @send_email_template:
                        conditions:
                            @and:
                                - @not_empty: $accountUser.owner
                                - @not_in: [$.saleRep, $.accountUserSalesReps]
                        parameters:
                            from: $accountUser.owner.email
                            to: $.saleRep.email
                            template: 'request_no_quote_alert'
                            entity: $.data

    orob2b_sale_frontend_quote_accept_and_submit_to_order:
        label: ' '
        applications: [frontend]
        enabled: true
        functions:
            - @assign_url:
                attribute: $.editLink
                route: orob2b_sale_quote_frontend_choice
                route_parameters: { 'id': $.data.id }
            - @translate:
                attribute: $.sourceRemoveLabel
                id: orob2b.frontend.shoppinglist.quote.remove_source.label
            - @assign_value:
                conditions:
                   @empty: $.data.quote.shippingEstimate
                parameters: [$.disallow_shipping_method_edit, false]
            - @assign_value:
                conditions:
                   @not_empty: $.data.quote.shippingEstimate
                parameters: [$.disallow_shipping_method_edit, true]
            - @tree:
                conditions:
                    @not_empty: $.data.quote.shippingAddress
                actions:
                    - @create_entity:
                        attribute: $.orderAddress
                        class: OroB2B\Bundle\OrderBundle\Entity\OrderAddress
                        data:
                            accountAddress: $.data.quote.accountAddress
                            accountUserAddress: $.data.quote.accountUserAddress
                            label: $.data.quote.shippingAddress.label
                            organization: $.data.quote.shippingAddress.organization
                            street: $.data.quote.shippingAddress.street
                            street2: $.data.quote.shippingAddress.street2
                            city: $.data.quote.shippingAddress.city
                            postalCode: $.data.quote.shippingAddress.postalCode
                            country: $.data.quote.shippingAddress.country
                            region: $.data.quote.shippingAddress.region
                            regionText: $.data.quote.shippingAddress.regionText
                            namePrefix: $.data.quote.shippingAddress.namePrefix
                            firstName: $.data.quote.shippingAddress.firstName
                            middleName: $.data.quote.shippingAddress.middleName
                            lastName: $.data.quote.shippingAddress.lastName
                            nameSuffix: $.data.quote.shippingAddress.nameSuffix
                            phone: $.data.quote.shippingAddress.phone
                            fromExternalSource: true
                    - @assign_value:
                        parameters: [$.disallow_shipping_address_edit, true]
            - @tree:
                conditions:
                      @empty: $.data.quote.shippingAddress
                actions:
                    - @assign_value: [$.orderAddress, null]
                    - @assign_value:
                        parameters: [$.disallow_shipping_address_edit, false]
            - @assign_value:
                parameters: [$.shippingEstimate, $.data.quote.shippingEstimate]
            - @start_checkout:
                source_name: 'quoteDemand'
                source_entity: $.data
                force: true
                data:
                    shippingAddress: $.orderAddress
                    shippingCost: $.shippingEstimate
                settings:
                    allow_source_remove: false
                    remove_source: false
                    source_remove_label: $.sourceRemoveLabel
                    edit_order_link: $.editLink
                    disallow_shipping_address_edit: $.disallow_shipping_address_edit
                    disallow_shipping_method_edit: $.disallow_shipping_method_edit

    orob2b_sale_frontend_quote_change:
          label: orob2b.frontend.sale.btn.accept_quote_create_order
          applications: [frontend]
          routes:
              - orob2b_sale_quote_frontend_view
          order: 20
          button_options:
              icon: icon-edit
              class:  quota-accept-btn
          functions:
              - @find_entity:
                  parameters:
                      class: OroB2B\Bundle\SaleBundle\Entity\QuoteDemand
                      attribute: $.quoteDemand
                      where:
                          quote: $.data
              - @create_entity:
                  attribute: $.quoteDemand
                  class: OroB2B\Bundle\SaleBundle\Entity\QuoteDemand
                  flush: true
                  data:
                      quote: $.data
                  conditions:
                      @empty: $.quoteDemand
              - @redirect:
                   parameters:
                       route: 'orob2b_sale_quote_frontend_choice'
                       route_parameters: {id: $.quoteDemand.id}
