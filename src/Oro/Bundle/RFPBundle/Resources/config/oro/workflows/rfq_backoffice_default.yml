workflows:
    rfq_backoffice_default:
        entity: Oro\Bundle\RFPBundle\Entity\Request
        entity_attribute: request

        applications: ['default']
        defaults: {active: true}

        exclusive_record_groups: ['b2b_rfq_backoffice_flow']

        start_step: open
        steps_display_ordered: true
        steps:
            open:
                order: 10
                allowed_transitions:
                    - process_transition
                    - request_more_information_transition
                    - decline_transition
                    - delete_transition
            processed:
                order: 20
                allowed_transitions:
                    - delete_transition
            more_info_requested:
                order: 30
                allowed_transitions:
                    - delete_transition
                    - info_provided_transition
            declined:
                order: 40
                allowed_transitions:
                    - delete_transition
                    - reprocess_transition
            deleted:
                order: 50
                allowed_transitions:
                    - undelete_transition

        attributes:
            notes:
                type: string

        transitions:
            __start__:
                is_start: true
                is_hidden: true
                is_unavailable_hidden: true
                step_to: open
                transition_definition: __start___definition
            process_transition:
                step_to: processed
                transition_definition: stub_transition_definition
            request_more_information_transition:
                step_to: more_info_requested
                transition_definition: request_more_information_transition_definition
                form_options:
                    attribute_fields:
                        notes:
                            form_type: oro_rich_text
                            options:
                                required: true
                                constraints:
                                  - NotBlank: ~
            decline_transition:
                step_to: declined
                transition_definition: decline_transition_definition
            delete_transition:
                step_to: deleted
                transition_definition: delete_transition_definition
            info_provided_transition:
                step_to: open
                transition_definition: stub_transition_definition
            reprocess_transition:
                step_to: open
                transition_definition: stub_transition_definition
            undelete_transition:
                step_to: open
                transition_definition: undelete_transition_definition

        transition_definitions:
            __start___definition:
                actions:
                    - '@request_enum_entity':
                        enum_code: 'rfp_internal_status'
                        attribute: $request.internalStatus
                        identifier: 'open'
                    - '@request_enum_entity':
                        enum_code: 'rfp_customer_status'
                        attribute: $request.customerStatus
                        identifier: 'submitted'
            request_more_information_transition_definition:
                actions:
                    - '@request_enum_entity':
                        enum_code: 'rfp_internal_status'
                        attribute: $request.internalStatus
                        identifier: 'more_info_requested'

                    - '@assign_constant_value':
                        attribute: $.result.note_type
                        value: Oro\Bundle\RFPBundle\Entity\RequestAdditionalNote::TYPE_SELLER_NOTE
                    - '@create_datetime':
                        attribute: $.result.current_date
                    - '@assign_active_user':
                        attribute: $.result.current_user
                    - '@create_entity':
                        class: Oro\Bundle\RFPBundle\Entity\RequestAdditionalNote
                        attribute: $.result.request_more_information_note
                        flush: true
                        data:
                            request: $.entity
                            type: $.result.note_type
                            text: $notes
                            author: $.result.current_user.fullName
                            createdAt: $.result.current_date
                            updatedAt: $.result.current_date
                            userId: $.result.current_user.id
                    - '@unset_value': [$notes] # unset temporary property
                    - '@call_method':
                        parameters:
                            object: $.result.request_more_information_note
                            method: addRequestAdditionalNote
                            method_parameters: [$.result.request_more_information_note]
            delete_transition_definition:
                actions:
                    - '@request_enum_entity':
                        enum_code: 'rfp_internal_status'
                        attribute: $request.internalStatus
                        identifier: 'deleted'
            decline_transition_definition:
                actions:
                    - '@request_enum_entity':
                        enum_code: 'rfp_internal_status'
                        attribute: $request.internalStatus
                        identifier: 'declined'
                    - '@request_enum_entity':
                        enum_code: 'rfp_customer_status'
                        attribute: $request.customerStatus
                        identifier: 'cancelled'
            undelete_transition_definition:
                actions:
                    - '@request_enum_entity':
                        conditions:
                            '@equal': ['cancelled', $request.customerStatus.id]
                        parameters:
                            enum_code: 'rfp_internal_status'
                            attribute: $request.internalStatus
                            identifier: 'cancelled_by_customer'
                    - '@request_enum_entity':
                        conditions:
                            '@not_equal': ['cancelled', $request.customerStatus.id]
                        parameters:
                            enum_code: 'rfp_internal_status'
                            attribute: $request.internalStatus
                            identifier: 'open'
            stub_transition_definition: ~
