workflows:
    rfq_backoffice_default:
        entity: Oro\Bundle\RFPBundle\Entity\Request
        entity_attribute: request

        applications: ['default']
        defaults: {active: true}

        exclusive_record_groups: ['b2b_rfq_backoffice_flow']

        start_step: open
        steps_display_ordered: true
        steps:
            open:
                order: 10
                allowed_transitions:
                    - process_transition
                    - request_more_information_transition
                    - decline_transition
                    - delete_transition
            processed:
                order: 20
                allowed_transitions:
                    - delete_transition
            more_info_requested:
                order: 30
                allowed_transitions:
                    - delete_transition
                    - info_provided_transition
            declined:
                order: 40
                allowed_transitions:
                    - delete_transition
                    - reprocess_transition
            deleted:
                order: 50
                allowed_transitions:
                    - undelete_transition

        attributes:
            notes:
                type: string

        transitions:
            __start__:
                is_start: true
                is_hidden: true
                is_unavailable_hidden: true
                step_to: open
                transition_definition: __start___definition
            process_transition:
                step_to: processed
                transition_definition: process_transition_definition
                is_hidden: true
                triggers:
                    -
                        entity_class: 'Oro\Bundle\RFPBundle\Entity\Request'
                        event: update
                        field: internal_status
                        require: "entity.getInternalStatus().getId() === 'processed'"
            request_more_information_transition:
                step_to: more_info_requested
                transition_definition: request_more_information_transition_definition
                form_options:
                    attribute_fields:
                        notes:
                            form_type: oro_rich_text
                            options:
                                required: true
                                constraints:
                                  - NotBlank: ~
            decline_transition:
                step_to: declined
                transition_definition: decline_transition_definition
            delete_transition:
                step_to: deleted
                transition_definition: delete_transition_definition
            info_provided_transition:
                step_to: open
                transition_definition: info_provided_transition_definition
                is_hidden: true
                triggers:
                    -
                        entity_class: 'Oro\Bundle\RFPBundle\Entity\Request'
                        event: update
                        field: internal_status
                        require: "entity.getInternalStatus().getId() === 'open'"
            reprocess_transition:
                step_to: open
                transition_definition: reprocess_transition_definition
                is_hidden: true
                triggers:
                    -
                        entity_class: 'Oro\Bundle\RFPBundle\Entity\Request'
                        event: update
                        field: internal_status
                        require: "entity.getInternalStatus().getId() === 'open'"
            undelete_transition:
                step_to: open
                transition_definition: undelete_transition_definition

        transition_definitions:
            __start___definition:
                actions:
                    - '@request_enum_entity':
                        enum_code: 'rfp_internal_status'
                        attribute: $request.internalStatus
                        identifier: 'open'
                    - '@request_enum_entity':
                        enum_code: 'rfp_customer_status'
                        attribute: $request.customerStatus
                        identifier: 'submitted'
            request_more_information_transition_definition:
                actions:
                    - '@request_enum_entity':
                        enum_code: 'rfp_internal_status'
                        attribute: $request.internalStatus
                        identifier: 'more_info_requested'

                    - '@assign_constant_value':
                        attribute: $.result.note_type
                        value: Oro\Bundle\RFPBundle\Entity\RequestAdditionalNote::TYPE_SELLER_NOTE
                    - '@run_action_group':
                        action_group: oro_rfp_create_request_additional_note
                        parameters_mapping:
                            request: $request
                            note_type: $.result.note_type
                            notes: $notes
                    - '@unset_value': [$notes] # unset temporary property
            delete_transition_definition:
                actions:
                    - '@request_enum_entity':
                        enum_code: 'rfp_internal_status'
                        attribute: $request.internalStatus
                        identifier: 'deleted'
            decline_transition_definition:
                actions:
                    - '@request_enum_entity':
                        enum_code: 'rfp_internal_status'
                        attribute: $request.internalStatus
                        identifier: 'declined'
                    - '@request_enum_entity':
                        enum_code: 'rfp_customer_status'
                        attribute: $request.customerStatus
                        identifier: 'cancelled'
            undelete_transition_definition:
                actions:
                    - '@request_enum_entity':
                        conditions:
                            '@equal': ['cancelled', $request.customerStatus.id]
                        parameters:
                            enum_code: 'rfp_internal_status'
                            attribute: $request.internalStatus
                            identifier: 'cancelled_by_customer'
                    - '@request_enum_entity':
                        conditions:
                            '@not_equal': ['cancelled', $request.customerStatus.id]
                        parameters:
                            enum_code: 'rfp_internal_status'
                            attribute: $request.internalStatus
                            identifier: 'open'
            process_transition_definition: ~
            info_provided_transition_definition: ~
            reprocess_transition_definition:
                actions:
                    - '@request_enum_entity':
                        enum_code: 'rfp_customer_status'
                        identifier: 'submitted'
                        attribute: $request.customerStatus
            stub_transition_definition: ~
