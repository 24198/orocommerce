definitions:
    change_category_position:
        label: 'Update product visibility after category position in tree changed'
        enabled: true
        order: 20
        entity: Oro\Bundle\CatalogBundle\Entity\Category
        actions_configuration:
            - '@change_category_position': ~

    # Product visibility update

    product_visibility_product_create:
        enabled: true
        label: 'Update product visibility after product created'
        entity: Oro\Bundle\ProductBundle\Entity\Product
        actions_configuration:
            - '@change_product_category': ~

    product_visibility_category_create:
        enabled: true
        label: 'Update product visibility after category created'
        entity: Oro\Bundle\CatalogBundle\Entity\Category
        actions_configuration:
            - '@find_entity':
                class: Oro\Bundle\AccountBundle\Entity\Visibility\CategoryVisibility
                where:
                    category: $.data
                attribute: $.visibilityEntity
            - '@tree':
                conditions:
                    '@empty': $.visibilityEntity
                actions:
                    - '@create_object': # there is no need to persist entity because it has default fallback
                        class: Oro\Bundle\AccountBundle\Entity\Visibility\CategoryVisibility
                        data:
                            category: $.data
                            visibility: parent_category
                        attribute: $.visibilityEntity
                    - '@change_category_visibility':
                        entity: $.visibilityEntity
            - '@foreach': # for all products in new category
                array: $products
                value: $.product
                actions:
                    - '@change_product_category':
                        entity: $.product

triggers:
    change_category_position:
        -
            event: update
            field: parentCategory

    product_visibility_product_create:
        -
            event: create

    product_visibility_category_create:
        -
            event: create
